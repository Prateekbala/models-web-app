suite: test rbac
templates:
  - rbac.yaml
tests:
  - it: should create RBAC resources when enabled
    set:
      rbac.create: true
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: ClusterRole
        documentIndex: 0
      - isKind:
          of: ClusterRoleBinding
        documentIndex: 1

  - it: should not create RBAC resources when disabled
    set:
      rbac.create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should have correct ClusterRole name
    set:
      rbac.create: true
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-kserve-models-web-app-cluster-role
        documentIndex: 0

  - it: should have correct ClusterRoleBinding name
    set:
      rbac.create: true
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-kserve-models-web-app-binding
        documentIndex: 1

  - it: should include required permissions for KServe
    set:
      rbac.create: true
    asserts:
      - contains:
          path: rules
          content:
            apiGroups:
              - serving.kserve.io
            resources:
              - inferenceservices
              - inferenceservices/status
            verbs:
              - get
              - list
              - watch
              - create
              - delete
              - deletecollection
              - patch
              - update
        documentIndex: 0

  - it: should include required permissions for Knative
    set:
      rbac.create: true
    asserts:
      - contains:
          path: rules
          content:
            apiGroups:
              - serving.knative.dev
            resources:
              - services
              - services/status
              - routes
              - routes/status
              - configurations
              - configurations/status
              - revisions
              - revisions/status
            verbs:
              - get
              - list
        documentIndex: 0