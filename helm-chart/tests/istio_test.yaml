suite: test istio resources
templates:
  - virtualservice.yaml
  - authorizationpolicy.yaml
tests:
  - it: should not create Istio resources when disabled
    set:
      istio.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should create VirtualService when Istio enabled
    set:
      istio.enabled: true
    template: virtualservice.yaml
    asserts:
      - isKind:
          of: VirtualService
      - equal:
          path: metadata.name
          value: RELEASE-NAME-kserve-models-web-app
      - equal:
          path: spec.http[0].match[0].uri.prefix
          value: "/kserve-endpoints/"
      - equal:
          path: spec.http[0].rewrite.uri
          value: "/"

  - it: should create AuthorizationPolicy when enabled
    set:
      istio.enabled: true
      istio.authorizationPolicy.enabled: true
    template: authorizationpolicy.yaml
    asserts:
      - isKind:
          of: AuthorizationPolicy
      - equal:
          path: metadata.name
          value: RELEASE-NAME-kserve-models-web-app
      - equal:
          path: spec.action
          value: ALLOW

  - it: should not create AuthorizationPolicy when disabled
    set:
      istio.enabled: true
      istio.authorizationPolicy.enabled: false
    template: authorizationpolicy.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should use custom gateways in VirtualService
    set:
      istio.enabled: true
      istio.virtualService.gateways:
        - custom/gateway
        - another/gateway
    template: virtualservice.yaml
    asserts:
      - equal:
          path: spec.gateways
          value:
            - custom/gateway
            - another/gateway

  - it: should use custom hosts in VirtualService
    set:
      istio.enabled: true
      istio.virtualService.hosts:
        - example.com
        - api.example.com
    template: virtualservice.yaml
    asserts:
      - equal:
          path: spec.hosts
          value:
            - example.com
            - api.example.com